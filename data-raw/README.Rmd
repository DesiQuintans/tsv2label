---
title: "Labelling datasets using a data dictionary, with `tsv2label`"
author: "Desi Quintans"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Installation

```{r message=FALSE, warning=FALSE, eval=FALSE}
remotes::install_github("DesiQuintans/tsv2label")
# CRAN coming soon
```

```{r}
library(tsv2label)
```


If you've ever tried to find your way through a dataset with cryptic names and values, you've probably made a spreadsheet that had columns like: 1) variable name, 2) what it contains, 3) what its types are, especially if it looks like they are coding for something.

`tsv2label` lets you use such a spreadsheet to label, rename, and factorise your dataset automatically; especially helpful if your dataset is hundreds of columns wide.

It uses tab-delimited spreadsheets which are editable in Excel; easy to assemble by copying and pasting from existing messy data dictionaries; can be cleaned and reshaped with regular expressions; and can be tracked and diffed with version control software.

![](data-raw/tsv2label.png)

--------------------------------------------------------------------------------

## What the package expects as a data dictionary

A data dictionary is a directory or .zip file with no subfolders, which contains tab-delimited spreadsheets in either _.TSV_ or _.TXT_ format. 

The Appendix below has the [formal definition of a dictionary](#formal-definition-of-a-tsv2label-data-dictionary), but the easiest way to understand how a data dictionary is shaped is by looking at the one that is included with `tsv2label`. You can find where it is installed on your computer by running:

```{r eval=FALSE}
library(tsv2label)

system.file("extdata/poker", package="tsv2label")
```

### Index file

The central file is called `index`; it must always exist.

```{r}
read.delim(system.file("extdata/poker/index.tsv", package="tsv2label")) |>
    head()
```
It has four columns:

1. `name` is the name of a column/variable in your dataset.
2. `rename` is what to rename the column. Leave it blank if unneeded.
3. `description` is a human-readable description of what the variable is about.
4. `factor_file` is used to convert categorical data into Factors. It has the filename (*without the file extension*) of a spreadsheet in the same folder that describes how values are mapped to labels, e.g. postal codes to place names. Leave it blank if unneeded. As you can see, many variables can use the same `factor_file`.



### Factor files

The factor files control how a variable is going to be converted to a Factor type. What you name the file does not matter, as long as you write its name exactly in the `index`'s `factor_file` fields (but without the file extension).

A factor file look like this:

```{r}
read.delim(system.file("extdata/poker/values_suits.tsv", package="tsv2label")) |> 
    head()
```

This file has three columns:

1. `level` contains the raw values in your dataset. It is used as the levels of the new factor.
2. `label` contains the label to apply to each level.
3. `ordered` controls whether this will be created as an ordered factor. An affirmative value (case-insensitive: `true`, `t`, `yes`, `y`, or `1`) in *any* cell of this column will make it an ordered factor.

These columns are named after their matching arguments in `factor()`:

```{r}
str(factor)
```

--------------------------------------------------------------------------------

# Functions

`tsv2label` gives you four main functions:

| Function                              | Description                            |
| :------------------------------------ | :------------------------------------- |
| `factorise_with_dictionary(df, path)` | Convert variables to Factor            |
| `describe_with_dictionary(df, path)`  | Add descriptions (labels) to variables |
| `rename_with_dictionary(df, path)`    | Rename variables                       |
|                                       |                                        |
| `revert_colnames(df, path)`           | Return columns to their original names |


## Order of operations {#order}

When `factorise_with_dictionary()` converts variables to Factors, any labels associated with them are lost. When `rename_with_dictionary()` renames variables, `factorise_with_dictionary()` and `describe_with_dictionary()` can no longer find and act on them. 

This means that operations should be done in the order given above: First factorising, then describing, then renaming. If needed, `revert_colnames()` can undo a renaming.


--------------------------------------------------------------------------------

# Example: Describing the Poker Hands dataset

`tsv2label` ships with a built-in dataset called `poker`, which is a subset of the [Poker Hand](https://archive.ics.uci.edu/ml/datasets/Poker+Hand) dataset with some added columns:

```{r}
head(poker)
```

As shown before, `tsv2label` also ships with the data dictionary for this dataset, in both .zip and folder forms:

```{r}
list.files(system.file("extdata", package = "tsv2label"))

list.files(system.file("extdata/poker", package = "tsv2label"))
```

```{r echo=FALSE}
`index.tsv` <- 
    system.file("extdata/poker/index.tsv", package = "tsv2label") |>
    read.delim()

`values_hands` <- 
    system.file("extdata/poker/values_hands.tsv", package = "tsv2label") |>
    read.delim()

`values_ranks` <- 
    system.file("extdata/poker/values_ranks.tsv", package = "tsv2label") |>
    read.delim()


`values_suits` <- 
    system.file("extdata/poker/values_suits.tsv", package = "tsv2label") |>
    read.delim()

```

```{r}
index.tsv
```

```{r}
values_hands
```

```{r}
values_ranks
```

```{r}
values_suits
```

### Preparation

Let's make a copy of `poker` that we can label.

```{r}
poker_copy <- poker
```

Let's also make a variable pointing to our data dictionary. For this vignette, this points to where my package is installed. Your install location will differ from mine if you run this code yourself. 

If you were using your own data dictionary, then this would be a path to where ever you have it on your computer.

```{r}
dictionary_dir <- system.file("extdata/poker", package = "tsv2label")
dictionary_dir
```

### Converting categorical variables to Factors

Converting to Factor always comes first in our [order of operations](#order-of-operations).

```{r}
# If you were using your own data dictionary, then your `path` argument would 
# point to its location on your computer.
factorise_with_dictionary(df = poker_copy, path = dictionary_dir)
```

Columns S1 to C5 all had a `factor_file` associated with them in `index`, so they were all converted to Factors:

```{r}
head(poker_copy)
```


### Adding labels/descriptions to columns

Adding variable descriptions comes next. These are used by many R packages to add extra functionality. For example, RStudio can display labels in `View()`, the [`gtsummary` package](https://github.com/ddsjoberg/gtsummary) uses the label attribute to name variables in its output tables where possible, and my [`sift` package](https://github.com/DesiQuintans/sift/) allows you to search the labels (among all other text in each variable) to find the right variable in large datasets.

```{r}
describe_with_dictionary(df = poker_copy, path = dictionary_dir)
```

All columns had a `description` in `index`, so all of them have a new `"label"` attribute:

```{r}
str(poker_copy, 1)
```

### Renaming variables

Finally, we can rename the variables based on the `rename` column in `index`.

```{r}
rename_with_dictionary(df = poker_copy, path = dictionary_dir)
```
The `FLIP` column did *not* have a `rename` associated with it in `index`, so it was not renamed.

```{r}
colnames(poker_copy)
```



--------------------------------------------------------------------------------

# Appendix

## Formal definition of a `tsv2label` data dictionary {#formal}

Formally, a data dictionary as recognised by the package as:

1. A directory or .zip file that contains a file called `index.tsv` or `index.txt` in its root folder.
    - Subfolders are permitted, but are not searched through. All dictionary files must be in the root.

2. For `index`:
    1. `index` **must** be a tab-separated spreadsheet. You can get this from Excel by saving your spreadsheet as *"Text (Tab delimited) (.txt)"*. .TXT files are recognised by `tsv2label`.
    2. `index` **must** have these four columns: 
        - `name` --- The exact name of a column in your dataframe. It's okay to have names that don't exist in the dataframe yet; this means that you can pre-name a variable that you expect to be creating in the future.
        - `rename` --- What to rename the column. Leave blank if you don't want to rename it.
        - `description` --- Description of what the column contains or is about. Also known as 'variable labels'.
        - `factor_file` --- For categorical data, the filename of a spreadsheet in the same folder (*without the file extension*) that describes how values are mapped to labels, e.g. postal codes to place names. These are also known as 'value labels'. Many rows can use the same factor file. Leave blank if not relevant.

3. **Optionally**, if defined in the `factor_file` column of the `index`, a number of factor files.
    1. These files **must** be in the same directory as `index`.
    2. These factor files **must** also be tab-separated spreadsheets.
    3. All factor files that were named in `index` **must** exist.
    4. Each factor file **must** have these columns:
        - `level` --- Values in the dataset. This is the `levels =` argument of `factor()`.
        - `label` --- Labels to apply to each level. This is the `labels =` argument of `factor()`.
        - `ordered` --- Should this be created as an ordered factor? This is the `ordered =` argument of `factor()`. You don't have to fill every cell in this column; an affirmative value in any of its cells will make it ordered. Affirmative values are case-insensitive and are `true`, `t`, `yes`, `y`, and `1`.
